<!DOCTYPE html>
<html>
<head>
  <%- include ("../partials/header.ejs") %>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-maskmoney/3.0.2/jquery.maskMoney.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
  <script type="text/javascript"> 
   // --------------- --------------- --------------- --------------- ---------------
   
    // Inicialização do Firebase:
    firebase.initializeApp( {
        apiKey: "AIzaSyAigFQ85uceRSjqC7hBL1ZlftNxWf0wWxo",
        authDomain: "multimedidor-tensao-corrente.firebaseapp.com",
        databaseURL: "https://multimedidor-tensao-corrente-default-rtdb.firebaseio.com",
        projectId: "multimedidor-tensao-corrente",
        storageBucket: "multimedidor-tensao-corrente.appspot.com",
        messagingSenderId: "942023989243",
        appId: "1:942023989243:web:723fac40e3f41065605d5e"
    });
    
	const { Pool } = require('pg');
	const pool = new Pool({
	  user: 'rnzsitjoavxdsi',
	  host: 'ec2-44-194-4-127.compute-1.amazonaws.com',
	  database: 'dbgdiqt270ssd7',
	  password: '082ca4bc3721a64672e28b8adc3375238d3b92b9295dd4faaf484e8901eed9ab',
	  port: 5432,
	  ssl: {
		rejectUnauthorized: false
	  }
	});
	
	//buscar valor no postgress
	async function buscarUltimoAlerta() {
	  const query = 'SELECT email, phone, consumo_mes FROM public.alerta ORDER BY set_date DESC LIMIT 1';
	  try {
		const res = await pool.query(query);
		console.log('Dados buscados com sucesso:', res.rows);
		return res.rows[0];
	  } catch (err) {
		console.error('Erro ao buscar os dados:', err);
		return null;
	  }
	}
	
	async function attValoresControle() {
	  const ultimoAlerta = await buscarUltimoAlerta();
	  if (ultimoAlerta) {
		// atualize os campos de entrada com os valores obtidos
		document.getElementById('controlevalorKwh').value = ultimoAlerta.consumo_mes;
		document.getElementById('emailControle').value = ultimoAlerta.email;
		document.getElementById('phoneControle').value = ultimoAlerta.phone;
	  }
	}
	
	
	// Função para enviar o valor para o postgree
	function enviarValorControle() {
		var valorControle = document.getElementById('controlevalorKwh').value;
		var emailControle = document.getElementById('emailControle').value;
		var phoneControle = document.getElementById('phoneControle').value;
		
		if (isNaN(valorControle)) {
			alert('O valor informado para o alerta de consumo não é válido');
		} else {
			  var valorControle = document.getElementById('controlevalorKwh').value;
			  var emailControle = document.getElementById('emailControle').value;
			  var phoneControle = document.getElementById('phoneControle').value;
			  inserirDados(emailControle, phoneControle, valorControle);
			  alert("Alerta configurado em " + valor + "Kwh");
		}
	  }
	

	async function inserirDados(email, phone, consumo_mes) {
	  const query = 'INSERT INTO public.alerta (email, phone, consumo_mes, set_date) VALUES ($1, $2, $3, NOW())';
	  const values = [email, phone, consumo_mes];
	  try {
		const res = await pool.query(query, values);
		console.log('Dados inseridos com sucesso:', res.rowCount);
	  } catch (err) {
		console.error('Erro ao inserir os dados:', err);
	  }
	}


	  
    function atualizarGrafico(value){
        $( "#chart_div" ).load( "/profile?date="+value+"");
    }

    function atualizarGraficoMes(value){
        $( "#chart_div" ).load( "/mes?date="+value+"");
    }

   function enviarCalculo(){

        if($("#datainicio").val() == ''){
            alert("Digita a data início, por favor")
            $("#datainicio").focus()
        } else  if($("#datafim").val() == ''){
            alert("Digita a data fim, por favor")
            $("#datafim").focus()
        }  else  if($("#valor").val() == ''){
            alert("Digita o valor, por favor")
            $("#valor").focus()
        }else{
        
            var url = "/medida?datainicio="+$("#datainicio").val()+"&datafim="+$("#datafim").val()+"&valor="+ (+$("#valor").val().replace('.', '').replace(',', '.').replace('R$', ''))+"";
        
            $( "#medida_data" ).load(url);
        }
       
    }
    var dia_atual =  new Date().toISOString();
    $(document).ready(function () { 

        $(function(){
            $('#valor').maskMoney({prefix:'R$ ', allowNegative: true, thousands:'.', decimal:',', affixesStay: true});
            // $('#datainicio').mask('99/99/9999');
            // $('#datafim').mask('99/99/9999');
        })

        
        var year =  new Date().toLocaleString("pt-br", {timeZone: "America/Sao_Paulo" , year: "numeric" });
        var month = new Date().toLocaleString("pt-br", {timeZone: "America/Sao_Paulo" , month: "2-digit"});
        var day =  new Date().toLocaleString("pt-br", {timeZone: "America/Sao_Paulo" , day: "2-digit"});

        const data_atual = year+"-"+month+"-"+day;
        //alert(data_atual )
        $( "#chart_div" ).load( "/profile?date="+data_atual);

        database.ref('VariaveisMedidas').on("value", function(snap) {

        
            today=new Date();
            const h=today.getHours();
            const m=today.getMinutes();
            const s=today.getSeconds();
        
        
            let horario = h+" : "+m+ " : "+s;
            let string_horario = h+""+m;


            console.log(horario);

            const dadosString = snap.val().dados;
            const dataSplit = dadosString.split("@");  
           
            if(dataSplit[0]){
                conta =  dataSplit[0].split(":");  
            }

            if(dataSplit[1]){
                voltagem =  dataSplit[1].split(":");  
            }



            if(dataSplit[2]){
                corrente =  dataSplit[2].split(":");  
            }

            if(dataSplit[3]){
                potencia =  dataSplit[3].split(":");  
            }

            if(dataSplit[4]){
                energia =  dataSplit[4].split(":");  
            }

            if(dataSplit[5]){
                frequencia =  dataSplit[5].split(":");  
            }

            if(dataSplit[6]){
                fatordepotencia =  dataSplit[6].split(":");  
            }

            if(dataSplit[7]){
            ativo =  dataSplit[7].split(":");  
        }

            document.getElementById("corrente-in").innerHTML = corrente[1].replace('.', ',');
            document.getElementById("potencia-in").innerHTML = potencia[1].replace('.', ',');
            document.getElementById("energia-in").innerHTML = energia[1].replace('.', ',');
            document.getElementById("frequencia-in").innerHTML = frequencia[1].replace('.', ',');
            document.getElementById("fator-in").innerHTML = fatordepotencia[1].replace('.', ',');
            document.getElementById("tensao-in").innerHTML = voltagem[1].replace('.', ',');
            
        });
    });
  </script>

</head>

<body onload="attValoresControle()">

  <%- include ("../partials/nav.ejs") %>

  <!-- Início -->
  <section class="inicio" id="inicio">
    <div class="texto-inicio">
        <h1>Multimedidor de <span>Tensão</span> e <span>Corrente</span></h1>
        <h2>Atualizações em tempo real</h2>
        <p>Multimedidor é um equipamento eletrônico capaz de realizar diversas medições em um circuito elétrico. Um multimedidor possui a função de medições instantâneas e acumulativas.</p>
    </div>
    <div class="imagem-inicio">
        <img src="/images/image-electrician.png" alt="Pessoa pensando envolta por gráficos e tecnologias.">
    </div>
</section>

  <!-- Medições -->
<section class="medicoes" id="medicoes">
    <div class="subtitulo">
        <h1>Medições</h1>
    </div>
    <div class="conteudo">
        <div class="barras-de-medicoes">
            <div class="texto-medicoes">
                <p>Listadas abaixo as medições capturadas em tempo real.</p>
            </div>
            <div class="caixa-de-medicoes">
                <i class="fa fa-bolt"><h3>Tensão</h3></i>
                <div>
                    <span id="tensao-in">0,0</span> V
                </div>
                <div class="porcentagem-barra barra-potencia"></div>
            </div>
          
            <div class="caixa-de-medicoes">
                <i class="fa fa-bolt"><h3>Corrente</h3></i>
                <div>
                    <span id="corrente-in">0,0</span> A
                </div>
                <div class="porcentagem-barra barra-corrente"></div>
            </div>
            <div class="caixa-de-medicoes">
                <i class="fa fa-bolt"><h3>Potência</h3></i>
                <div>
                    <span id="potencia-in">0,0</span> W
                </div>
                <div class="porcentagem-barra barra-potencia"></div>
            </div>
            <div class="caixa-de-medicoes">
                <i class="fa fa-bolt"><h3>Energia</h3></i>
                <div>
                    <span id="energia-in">0,0</span> kWh
                </div>
                <div class="porcentagem-barra barra-energia"></div>
            </div>
            <div class="caixa-de-medicoes">
                <i class="fa fa-bolt"><h3>Frequência</h3></i>
                <div>
                    <span id="frequencia-in">0,0</span> Hz
                </div>
                <div class="porcentagem-barra barra-frequencia"></div>
            </div>
            <div class="caixa-de-medicoes">
                <i class="fa fa-bolt"><h3>Fator de Potência</h3></i>
                <div>
                    <span id="fator-in">0,0</span> kVAr
                </div>
                <div class="porcentagem-barra barra-fator-de-potencia"></div>
            </div>
        </div>
    </div>
</section>
		
<section class="controle" id="controle">
    <div class="subtitulo">
        <h1>Alerta de consumo </h1>
    </div>
    <div class="conteudo">
		<div>
			<br> 
			<p style="font-size: var(--tamanho-p);margin: 1rem 0;">Configurar alerta de consumo mensal. <br>
			Ao chegar no valor estabelecido um alerta é enviado.</p>
			<br>
			<div style="display: flex;">
			
				<span style="width:200px;">
					Consumo mensal kWh:&nbsp;
				</span>
				<input type="text" id="controlevalorKwh" style="width: 120px;" name="controlevalorKwh">
			</div>
			<br>
		
			<div style="display: flex;">
				<span style="width:200px;">
					Telefone:&nbsp;
				</span>
				<input type="tel" id="phoneControle" style="width: 150px;" name="phoneControle">
			</div>
			
			<br>
			<div style="display: flex;">
				<span style="width:200px;">
					Email:&nbsp;
				</span>
				<input type="email" id="emailControle" style="width: 200px;" name="emailControle">
			</div>
			<br>
			
			<div>
				<br>
				<input onclick="enviarValorControle()" style="width:400px; background-color:var(--cor-primaria); color: white;" type="button" value="Configurar controle">
			</div>
		  
		</div>

    </div>
</section>


<section class="grafico" id="grafico">
    <div class="subtitulo">
        <h1>Gráficos</h1>
    </div>

    <div class="conteudo">
        <div class="barras-de-medicoes-na">
            <div>
                <span>
                    Data :
                </span>

                <!-- Encapsule o date picker em um container -->
                <div class="datePickerContainer" style="display: inline-block; position: relative;">
                    <input type="text" id="datePickerInput" placeholder="Escolha uma data">
                    <!-- Adicionei um elemento para exibir a data selecionada -->
                    <span id="datePickerLabel" style="margin-left: 5px; cursor: pointer;"></span>
                    <div id="datePickerOptions">
                        <label><input type="radio" name="period" value="day"> Dia</label>
                        <label><input type="radio" name="period" value="week"> Semana</label>
                        <label><input type="radio" name="period" value="month"> Mês</label>
                        <label><input type="radio" name="period" value="semester"> Semestre</label>
                        <label><input type="radio" name="period" value="year"> Ano</label>
                        <br>
                        <label><input type="radio" name="time" value="current" checked> Atual</label>
                        <label><input type="radio" name="time" value="past"> Passado</label>
                    </div>
                </div>

                <script>
                    const datePickerInput = document.getElementById("datePickerInput");
                    const datePickerOptions = document.getElementById("datePickerOptions");
            
                    const flatpickrInstance = flatpickr(datePickerInput, {
                        mode: "range",
                        maxDate: "tomorrow",
                        dateFormat: "d/m/Y",
                        locale: "pt",
                        firstDayOfWeek: 0,
                        onClose: function (selectedDates, dateStr) {
                            updateLabel(dateStr);
                        },
                        onOpen: function () {
                            const fp = this;
                            if (!fp.calendarContainer.contains(datePickerOptions)) {
                                fp.calendarContainer.appendChild(datePickerOptions);
                            }
                            datePickerOptions.style.display = 'block';
                        }
                    });
            
                    datePickerOptions.addEventListener("change", function (event) {
                        if (event.target.name === "period" || event.target.name === "time") {
                            flatpickrInstance.close();
                            updateDatePicker(flatpickrInstance);
                            flatpickrInstance.open();
                        }
                    });
            
                    // Restante do código
            
                    function updateDatePicker(fp) {
                        const period = document.querySelector('input[name="period"]:checked').value;
                        const time = document.querySelector('input[name="time"]:checked').value;
                        const today = new Date();
                        let startDate = new Date(today);
                        let endDate = new Date(today);
            
                        if (period === "day") {
                            if (time === "past") {
                                startDate.setDate(startDate.getDate() - 1);
                                endDate.setDate(endDate.getDate() - 1);
                            }
                        } else if (period === "week") {
                            if (time === "current") {
                                startDate.setDate(startDate.getDate() - (startDate.getDay() - 1));
                            } else {
                                startDate.setDate(startDate.getDate() - (startDate.getDay() + 6));
                                endDate.setDate(startDate.getDate() + 6);
                            }
                            
                        } else if (period === "month") {
                            if (time === "past") {
                                startDate.setMonth(startDate.getMonth() - 1);
                                endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
                            }
                            startDate.setDate(1);
                            
                        } else if (period === "semester") {
                            if (time === "past") {
                                startDate.setMonth(startDate.getMonth() - 6);
                                endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 6, 0);
                            }
                            startDate.setMonth(Math.floor(startDate.getMonth() / 6) * 6);
                            startDate.setDate(1);
                        } else if (period === "year") {
                            if (time === "past") {
                                startDate.setFullYear(startDate.getFullYear() - 1);
                                endDate = new Date(startDate.getFullYear() + 1, 0, 0);
                            }
                            startDate.setMonth(0);
                            startDate.setDate(1); 
                        }
            
                        fp.setDate([startDate, endDate]);
                    }
            
                    function updateLabel(dateStr) {
                        const dates = dateStr.split(" to ");
                        if (dates.length === 1) {
                            datePickerLabel.textContent = dates[0];
                        } else if (dates.length === 2) {
                            datePickerLabel.textContent = `${dates[0]} até ${dates[1]}`;
                        }
                    }
            
                    datePickerLabel.addEventListener("click", function () {
                        flatpickrInstance.open();
                    });
                </script>

            </div>

            <br>
            <label for="tipo_grafico">Tipo:</label><br>
            <input type="radio" id="consumo" name="tipo_grafico" value="consumo" checked>
            <label for="consumo">Consumo</label><br>
            <input type="radio" id="qualidade" name="tipo_grafico" value="qualidade">
            <label for="qualidade">Qualidade</label><br>
        </div>

        <div id="chart_div" style="width: 100%; height: 400px;"></div>
    </div>
</section>


<section class="atual" class="consumo" id="consumo">
    <div class="subtitulo">
        <h1>Consumo</h1>
    </div>
   
    <div class="conteudo">

    <div class="barras-de-medicoes-na">
        <div>
            <br> 
            <p style="font-size: var(--tamanho-p);margin: 1rem 0;">Calcular consumo R$</p>
            <br>
            <div style="display: flex;">
            
                <span style="width:100px;">
                    Data início:&nbsp;
                </span>
                <input type="date" id="datainicio"  style='width: 120px;' name="valor">
            </div>
            <br>
            <div style="display: flex;">
                <span  style="width:100px;">
                    Data fim:&nbsp;
                </span>
                <input type="date" id="datafim"  style='width: 120px;' name="valor">
            </div>
            <br>
            <div style="display: flex;">
                <span  style="width:100px;">
                    Valor:&nbsp;
                </span>
                <input type="text" id="valor"  style='width: 120px;' name="valor">
            </div>

            <div >
                <br>
                <input  onclick="enviarCalculo()" style="width:220px; background-color:var(--cor-primaria); color: white;" type="button" value="Calcular">
            </div>
            <div id="medida_data">
                <div >
                
                        <div class="caixa-de-medicoes">
                        <i class="fa fa-bolt"><h3></h3></i>
                        <div>
                            <span id="potencia-in-media">00</span> 
                        </div>
                        <div class="porcentagem-barra barra-potencia"></div>
                    </div>
            
                    <div >
                        
                        <div class="caixa-de-medicoes">
                        <i class="fa fa-money"><h3></h3></i>
                        <div>
                            <span id="potencia-in-media">00</span> 
                        </div>
                        <div class="porcentagem-barra barra-potencia"></div>
                    </div>
                    </div>
                </div>
            </div>
       </div>
       <div>
            <div class="">
                <div class="texto-medicoes">
                    <p>Listados abaixo as medições armazenadas ao longo do
                        tempo.</p>
                </div>
            
                <div class="caixa-de-medicoes">
                    <i class="fa fa-bolt"><h3>Hoje</h3></i>
                    <div>
                        <span id="corrente-in"><%=data_hoje[0].hoje.replace('.', ',');%> kWh</span> 
                    </div>
                    <div class="porcentagem-barra barra-corrente"></div>
                </div>
                <div class="caixa-de-medicoes">
                    <i class="fa fa-bolt"><h3>Mês</h3></i>
                    <div>
                        <span id="potencia-in"><%=data_mes[0].mes.replace('.', ',');%> kWh</span> 
                    </div>
                    <div class="porcentagem-barra barra-potencia"></div>
                </div>
            
                <div class="caixa-de-medicoes">
                    <i class="fa fa-bolt"><h3>Total</h3></i>
                    <div>
                        <span id="fator-in"><%=data_final[0].tudo.replace('.', ',');%> kWh</span> 
                    </div>
                    <div class="porcentagem-barra barra-fator-de-potencia"></div>
                </div>
            </div>
       </div>
 
    </div>
</section>

 <!-- Direitos Autorais -->
 <div class="direitos-autorais">
  <p>&#169; Instituto Federal de Goiás</p>
</div>


<!-- Font Awesome -->
<script src="https://kit.fontawesome.com/c1a3e9b7cb.js" crossorigin="anonymous"></script>

</body>
</html>

